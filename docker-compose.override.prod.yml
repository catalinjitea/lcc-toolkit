version: '2'

services:

  nginx:
    image: nginx:alpine
    container_name: lcct.nginx
    hostname: lcct.nginx
    ports:
      - "127.0.0.1:8001:80"
    environment:
      NGINX_CONF: |-
        server {
          listen 80;

          access_log /var/log/nginx/access.log main;

          location /static {
            sendfile on;
            tcp_nopush on;
            gzip on;
            gzip_types text/plain application/x-javascript text/css;
            expires 1d;
            root /var/www/lcct;
          }

          location /files {
            sendfile on;
            tcp_nopush on;
            gzip on;
            gzip_types text/plain application/x-javascript text/css;
            expires 1d;
            alias /opt/lcct/media/uploadfiles;
          }
        }
    depends_on:
      - web
    volumes:
      - static-files:/var/www/lcct/static:ro
      - media-files:/opt/lcct/media/uploadfiles:ro
    command: /bin/sh -c 'echo "$$NGINX_CONF" > /etc/nginx/conf.d/default.conf && exec nginx -g "daemon off;"'

  web:
    image: eaudeweb/lcc-toolkit:1.0.7
    container_name: lcct.web
    hostname: lcct.web
    ports:
      - "127.0.0.1:8000:8000"
    environment:
      - DJANGO_MANAGEPY_MIGRATE=on
      - DJANGO_MANAGEPY_COLLECTSTATIC=on
      - DJANGO_MANAGEPY_LOADFIXTURES=on
      - STATIC_ROOT=/var/www/lcct/static

    volumes:
      - static-files:/var/www/lcct/static
      - media-files:/opt/lcct/media/uploadfiles

  db:
    container_name: lcct.db
    hostname: lcct.db

  elasticsearch:
    container_name: lcct.elastic
    hostname: lcct.web
    ports:
      - "127.0.0.1:9200:9200"

  logspout:
    image: gliderlabs/logspout:v3.2.3
    container_name: lcct.logs
    hostname: lcct.logs
    environment:
      - HOST=logsN.papertrailapp.com
      - PORT=XXXXX
    volumes:
      - '/var/run/docker.sock:/tmp/docker.sock'
    command: 'syslog://$${HOST}:$${PORT}?filter.name=lcct.*'

volumes:
  static-files:
    driver: local

  media-files:
    driver: local
